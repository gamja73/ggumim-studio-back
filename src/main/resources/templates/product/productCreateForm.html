<th:block th:replace="~{/common/commonHead}"></th:block>
<head>
    <link rel="stylesheet" href="/css/quill.snow.css">
</head>
<th:block th:replace="~{/common/commonHeader}"></th:block>
<!-- main content -->
<div class="container-fluid">
    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">상품 등록</h1>

    <div class="card shadow mb-4">
        <div style="width: 80%; margin: 10px auto">
            <label>메인 상품 이미지</label>
            <input type="file" id="productMainImgInput" class="form-control" accept="image/jpeg, image/png">
            <div id="productMainImg" style="width: 300px; height: 300px; display: none;">
                <img style="width: 100%; height: 100%;" src="">
            </div>

            <label for="productName">상품명</label>
            <input type="text" class="form-control" id="productName">

            <label for="productDescription">상품 설명</label>
            <input type="text" class="form-control" id="productDescription">

            <label for="productPrice">상품 가격</label>
            <input type="number" class="form-control" id="productPrice">

            <label for="productCategory">상품 카테고리</label>
            <input type="text" class="form-control" id="productCategory">

            <label for="productDetailEditor" style="margin-top: 10px;">상품 상세</label>
            <div id="productDetailEditor"></div>
        </div>

        <button class="btn btn-primary" style="width: max-content; right: 10px;" onclick="createProduct()">저장</button>
    </div>
</div>
<!-- /.container-fluid -->
<th:block th:replace="~{/common/commonFooter}"></th:block>
<script type="text/javascript" src="/js/quill.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
            ['blockquote', 'code-block'],
            ['link', 'image'],
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['clean']                                         // remove formatting button
        ];

        const productDetailEditor = new Quill("#productDetailEditor", {
            theme: "snow",
            modules: {
                toolbar: toolbarOptions,
            },
        });

        const imageHandler = () => {
            const range = productDetailEditor.getSelection();
            const input = document.createElement("input");
            input.setAttribute("type", "file");
            input.setAttribute("accept", "image/jpeg, image/png");
            input.click();

            input.onchange = () => {
                imgFileUploadByHandler(input, productDetailEditor, range);
            };
        };

        productDetailEditor.getModule("toolbar").addHandler("image", imageHandler);

        document.getElementById("productMainImgInput").addEventListener("change", (event) => {
            const file = event.target.files[0];

            if (file)
            {
                const reader = new FileReader();

                reader.onload = (e) => {
                    document.getElementById("productMainImg").style.display = "block";
                    document.querySelector("#productMainImg > img").src = e.target.result;
                }

                reader.readAsDataURL(file);
            }
            document.querySelector("#productMainImg > img").src = document.getElementById("productMainImgInput").files[0];
        })
    });

    const createProduct = async () => {
        const productMainImgInput = document.getElementById("productMainImgInput");
        const productName = document.getElementById("productName");
        const productDescription = document.getElementById("productDescription");
        const productPrice = document.getElementById("productPrice");
        const productCategory = document.getElementById("productCategory");
        const productDetailEditor = document.getElementById("productDetailEditor");

        if (!productMainImgInput.files[0])
        {
            alert("상품 이미지를 등록해주세요.");
            return
        }

        if (productName.value === "" || productName.value.length <= 0)
        {
            alert("상품명을 입력해주세요.");
            return;
        }

        if (productDescription.value === "" || productDescription.value.length <= 0)
        {
            alert("삼품 설명을 입력해주세요.");
            return;
        }

        if (productPrice.value === "" || productPrice.value.length <= 0)
        {
            alert("상품 가격을 입력해주세요.");
            return;
        }

        const data = {
            productName: productName.value,
            productDescription: productDescription.value,
            productPrice: productPrice.value,
            productCategory: productCategory.value,
            productDetailEditor: productDetailEditor.innerHTML,
        }

        const file = productMainImgInput.files[0];

        if (!file) {
            alert("Please select a file first.");
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        await apiRequest(
            HttpMethod.POST,
            "/api/v1/admin/file",
            formData,
            (res) => {
                data.productMainImg = res.webpUrl;

                apiRequest(
                    HttpMethod.POST,
                    "/api/v1/admin/product",
                    data,
                    (res) => {
                        alert(res);
                        window.location.href = "/admin/product/list"
                    },
                    (err) => {
                        alert(err)
                    }
                )
            },
            (err) => {
                alert(err)
                return null;
            }, true
        )
    }

    const imgFileUploadByHandler = async (input, productDetailEditor, range) => {
        const file = input.files[0];  // 사용자가 선택한 첫 번째 파일

        if (!file) {
            alert("Please select a file first.");
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        await apiRequest(
            HttpMethod.POST,
            "/api/v1/admin/file",
            formData,
            (res) => {
                productDetailEditor.insertEmbed(range.index, 'image', res.webpUrl);
            },
            (err) => {
                alert(err)
            }, true
        )
    }

</script>
<th:block th:replace="~{/common/commonFoot}"></th:block>